---
title: "temp"
author: "Abhraneel Sarma"
date: "2/19/2022"
output:
  html_document:
    css: ../inst/css/styles.css
  pdf_document: default
---

```{r setup} 
library(dplyr)
library(tidyr)
library(purrr)
devtools::load_all(".")

knit_as_emar()
```


```{r, include = FALSE}
###### this does not let us create a wrapper function as easily so
###### the user will have to declare the entire block of code below:

# includeScript("https://code.jquery.com/jquery-3.6.0.min.js")
# includeScript(system.file("js/Tangle.js", package="multiverse"))
# includeScript(system.file("js/TangleKit/mootools.js", package="multiverse"))
# includeScript(system.file("js/TangleKit/sprintf.js", package="multiverse"))
# includeScript(system.file("js/TangleKit/BVTouchable.js", package="multiverse"))
# includeScript(system.file("js/TangleKit/TangleKit.js", package="multiverse"))
# includeScript(system.file("js/custom.js", package="multiverse"))

###### on the other hand, htmltools::tags allows us to create a wrapper function like so
###### which can be exported by the multiverse package:
create_interactive_multiverse_doc = function () {
  htmltools::tagList(
    htmltools::tags$script(src = "https://code.jquery.com/jquery-3.6.0.min.js"),
    htmltools::tags$script(src = system.file("js/Tangle.js", package="multiverse")),
    htmltools::tags$script(src = system.file("js/TangleKit/mootools.js", package="multiverse")),
    htmltools::tags$script(src = system.file("js/TangleKit/sprintf.js", package="multiverse")),
    htmltools::tags$script(src = system.file("js/TangleKit/BVTouchable.js", package="multiverse")),
    htmltools::tags$script(src = system.file("js/TangleKit/TangleKit.js", package="multiverse")),
    htmltools::tags$script(src = system.file("js/custom.js", package="multiverse"))
  )
}

create_interactive_multiverse_doc()
```



## Multiverse case study #4

```{r}
data("hurricane")

hurricane_data <- hurricane %>%
    # rename some variables
    rename(
        year = Year,
        name = Name,
        dam = NDAM,
        death = alldeaths,
        female = Gender_MF,
        masfem = MasFem,
        category = Category,
        pressure = Minpressure_Updated_2014,
        wind = HighestWindSpeed
    ) %>%
    # create new variables
    mutate(
        post = ifelse(year>1979, 1, 0),
        zcat = as.numeric(scale(category)),
        zpressure = -scale(pressure),
        zwind = as.numeric(scale(wind)),
        z3 = as.numeric((zpressure + zcat + zwind) / 3)
    )
```


## Multiverse Analysis

To implement a multiverse analysis, we first need to create the `js parameter('masfem')` object <damage_transform/>:

```{r}
M = multiverse()
```

```{multiverse default-m-1, inside = M}
# here we just create the variable `df` in the multiverse
df = hurricane_data

# here, we perform a `filter` operation in the multiverse
df.filtered = df %>%
  filter(branch(death_outliers,
      "no_exclusion" ~ TRUE,
      "most_extreme" ~ name != "Katrina",
      "two_most_extreme" ~ !(name %in% c("Katrina", "Audrey"))
))
```

```{multiverse label = variable_definitions, inside = M}
df.filtered = df.filtered %>%
    mutate(
        femininity = branch(femininity_calculation,
          "masfem" ~ masfem,
          "female" ~ female
        ),
        damage = branch(damage_transform,
          "no_transform" ~ identity(dam),
          "log_transform" ~ log(dam)
        )
    )
```


```{multiverse default-m-2, inside = M}
mean(df.filtered$femininity)
```


```{multiverse default-m-5, inside = M}
hist(df.filtered$femininity)
hist(df.filtered$damage)
head(df.filtered)
```


```{r}
expand(M)
```



---
title: "An Explorable Multiverse Analysis of Durante et al. (2013)"
author: "Abhraneel Sarma"
date: "2/19/2022"
output:
  html_document:
    css: ../inst/css/styles.css
  pdf_document: default
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE, results = "hide"} 
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(broom)
library(gganimate)
library(cowplot)
devtools::load_all(".")
```

```{r}
knit_as_emar()
```



## Introduction
Steegen and colleagues [1] introduced the concept of multiverse analysis, which they illustrated by re-analyzing data from a 2013 paper by Durante and colleagues [2] entitled “The fluctuating female vote: Politics, religion, and the ovulatory cycle”. In this paper, we reproduce a small part of Steegen et al.’s multiverse analysis of Durante et al.’s study using explorable explanations. The data processing options can be selected interactively, which allows us to show the interaction plot reported in Durante et al. in addition to the p-value.

## Analysis

The default analysis below reflects the choices made by Durante et al. [2]. Other options reflect alternatives considered by Steegen et al. [1]. Much of the text below is copied from Steegen et al. [1], in order to give an idea of what their article could have looked liked had they used explorable explanations. We first begin by loading the data used in the analysis and transforming six variables (`Abortion`, `StemCell`..., `Profit`) and creating three new variables (`FiscConsComp`, `SocConsComp`, `RelComp`).

```{r}
data("durante")

data.raw.study2 <- durante %>%
  mutate(
    Abortion = abs(7 - Abortion) + 1,
    StemCell = abs(7 - StemCell) + 1,
    Marijuana = abs(7 - Marijuana) + 1,
    RichTax = abs(7 - RichTax) + 1,
    StLiving = abs(7 - StLiving) + 1,
    Profit = abs(7 - Profit) + 1,
    FiscConsComp = FreeMarket + PrivSocialSec + RichTax + StLiving + Profit,
    SocConsComp = Marriage + RestrictAbortion + Abortion + StemCell + Marijuana,
    RelComp = round((Rel1 + Rel2 + Rel3)/3, 2)
  )
```

To implement a multiverse analysis, we first define the multiverse object:

```{r}
M = multiverse()
```

### Fertility

Durante et al. classify women into a high or low fertility group based on cycle day. There are different reasonable ways of estimating a woman’s next menstrual onset, which is an intermediate step in determining cycle day. The perform this calculation in two ways <mv param="menstrual_calculation"/>

```{multiverse cycle-length-calc, inside = M}
df = data.raw.study2 %>%
    mutate( ComputedCycleLength = StartDateofLastPeriod - StartDateofPeriodBeforeLast )  %>%
    mutate(NextMenstrualOnset = branch(menstrual_calculation,
        "mc_option1" ~ StartDateofLastPeriod + ComputedCycleLength,
        "mc_option2" ~ StartDateofLastPeriod + ReportedCycleLength,
        "mc_option3" ~ StartDateNext)
    )  %>%
    mutate(
      CycleDay = 28 - (NextMenstrualOnset - DateTesting),
      CycleDay = ifelse(WorkerID == 15, 11, ifelse(WorkerID == 16, 18, CycleDay)),
      CycleDay = ifelse(CycleDay > 1 & CycleDay < 28, CycleDay, ifelse(CycleDay < 1, 1, 28))
    )
```

The classification of women into a high or low fertility group based on cycle day can be done in several ways <mv param="fertility"/>:

```{multiverse fertility-calc, inside = M}
df = df %>%
    mutate( Fertility = branch( fertility,
        "fer_option1" ~ factor( ifelse(CycleDay >= 7 & CycleDay <= 14, "high", ifelse(CycleDay >= 17 & CycleDay <= 25, "low", NA)) ),
        "fer_option2" ~ factor( ifelse(CycleDay >= 6 & CycleDay <= 14, "high", ifelse(CycleDay >= 17 & CycleDay <= 27, "low", NA)) ),
        "fer_option3" ~ factor( ifelse(CycleDay >= 9 & CycleDay <= 17, "high", ifelse(CycleDay >= 18 & CycleDay <= 25, "low", NA)) ),
        "fer_option4" ~ factor( ifelse(CycleDay >= 8 & CycleDay <= 14, "high", "low") ),
        "fer_option5" ~ factor( ifelse(CycleDay >= 8 & CycleDay <= 17, "high", "low") )
    ))
```

### Relationship status
There are at least three options for the dichotomization of women’s relationship status into single or committed <mv param = "relationship_status">:

```{multiverse relationship-calc, inside = M}
df = df %>%
    mutate(RelationshipStatus = branch(relationship_status,
        "rs_option1" ~ factor(ifelse(Relationship==1 | Relationship==2, 'Single', 'Relationship')),
        "rs_option2" ~ factor(ifelse(Relationship==1, 'Single', 'Relationship')),
        "rs_option3" ~ factor(ifelse(Relationship==1, 'Single', ifelse(Relationship==3 | Relationship==4, 'Relationship', NA))) )
    )
```


### Exclusion criteria

The assignment of the participants to a high or low fertility group automatically excludes women whose cycle days are not in the high or low fertility range <mv param="cycle_length"/>.

```{multiverse outlier-removal-1, inside = M}
df = df %>%
    filter( branch(cycle_length, 
      "cl_option1" ~ TRUE,
      "cl_option2" ~ ComputedCycleLength > 25 & ComputedCycleLength < 35,
      "cl_option3" ~ ReportedCycleLength > 25 & ReportedCycleLength < 35
    ))
```


Because a lot of this data involves participants' self reported measures, it is not unreasonable to exclude participants who are unsure of their responses <mv param="certainty"/>:

```{multiverse outlier-removal-2, inside = M}
df = df %>%
    dplyr::filter( branch(certainty,
        "cer_option1" ~ TRUE,
        "cer_option2" ~ Sure1 > 6 | Sure2 > 6
    ))
```

## Results

The authors evaluate the impact of a participants `Fertility`, `RelationshipStatus` and it's interaction on their *Religiosity* which is defined using the composite variable `RelComp`.


```{multiverse regression-analysis, inside = M}
fit_RelComp <- lm( RelComp ~ 0 + Fertility * RelationshipStatus, data = df )

p_val = round(summary(fit_RelComp)$coefficients[4, 4], 3)
if (p_val < 0.05) p_val = paste0(p_val, " *")

broom::augment(fit_RelComp, interval = "confidence") %>%
  group_by(Fertility, RelationshipStatus) %>%
  mutate(RelationshipStatus = ifelse(RelationshipStatus == "Relationship", "In Relationship", "Single")) %>%
  summarise(.fitted = mean(.fitted), .upper = mean(.upper), .lower = mean(.lower), .groups = "drop") %>%
  ggplot(aes(x = RelationshipStatus, y = .fitted, fill = Fertility)) +
  geom_bar(stat = "identity", position = position_dodge2(preserve = "single"), width = 0.5) +
  geom_linerange(aes(ymin = .lower, ymax = .upper), position = position_dodge(width = 0.5)) +
  geom_text(label = paste0("Interaction: ", p_val), x = 1.5, y = 7.5, colour = "#666666") +
  labs(x = "Relationship Status", y = "Religiosity Composite Score") +
  ylim(c(0, 8.1)) +
  theme_minimal()
```


The interaction between relationship status and fertility in study 1 is shown in Figure 1. This plot reproduces Figure 1 from Durante et al.’s article [2] but with the y-axis starting at zero. This figure does not appear Steegen et al.’s multiverse analysis [1], as there would be 180 such figures to show, which would be impractical with a static paper. The p-value for the interaction is also shown on Figure 1.

## Discussion
As in the original paper, we can see that “the multiverse analysis revealed that almost all choice combinations for data processing lead to large p values” [1] and we can again conclude that “the effect of fertility on religion seems too sensitive to arbitrary choices and thus too fragile to be taken seriously” [1]. Figure 1 can animated by holding the ‘A’ key, giving a striking demonstration of the variability of effect sizes across the multiverse that can usefully complement Steegen et al’s histogram of p-values.





